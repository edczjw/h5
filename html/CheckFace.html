<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>活体检测</title>
    <meta name="description" content="">
    <meta name="viewport"
        content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0,user-scalable=no,shrink-to-fit=no">
    <link rel="stylesheet" href="../css/CheckFace.css">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vant@2.0/lib/index.css">

    <!-- 引入组件,注意引入顺序 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vant@2.0/lib/vant.min.js"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
</head>

<body>
    <div id="app">
        <div class="top-step">
            <van-steps :active="active">
                    <van-step><a href="../html/basicPage.html">基本信息</a></van-step>
                    <van-step><a href="../html/CheckFace.html">活体检测</a></van-step>
                    <van-step><a href="../html/WorkMsg.html">工作信息</a></van-step>
                    <van-step><a href="../html/Contract.html">联系人员</a></van-step>
                    <van-step><a href="../html/UserCommit.html">用户认证</a></van-step>
            </van-steps>
        </div>
        <div class="container">
            <!--bootstrap提示框-->
            <div class="LivAlert">
            </div>
            <!--活体界面-->
            <div class="Living" style="display:block">
                <div class="sketch">
                    <div class="sketch-img"></div>
                    <p class="sketch-text">正面平视手机、保证光线充足<br>请勿遮挡面部</p>
                </div>
                <div class="prompt">
                    <div class="prompt-box">
                        <div class="prompt-box-text">
                            <span class="prompt-box-text-number">1</span>
                            <span class="prompt-box-text-content">牢记验证码，点击开始录制</span>
                            <span class="prompt-box-text-border"></span></div>
                        <div class="prompt-box-text">
                            <span class="prompt-box-text-number">2</span>
                            <span class="prompt-box-text-content">开启前置摄像头，普通话朗读数字</span>
                            <span class="prompt-box-text-border"></span></div>
                        <div class="prompt-box-text">
                            <span class="prompt-box-text-number">3</span>
                            <span class="prompt-box-text-content">完成录制，等待验证结果</span>
                        </div>
                    </div>
                    <span class="prompt-next nextVideo">活体人脸认证</span>
                    
                </div>

                <div class="modal-layer" style="display:none;">
                    <div class="modal-layer-mask"></div>
                    <div class="modal-layer-popup">
                        <div class="modal-layer-success">
                            <div class="modal-layer-popup-title">请牢记以下验证码</div>
                            <div class="modal-layer-popup-content">
                                此验证码将于<span>48</span>秒后过期<br>用普通话朗读数字，视频时长<span>3-6</span>秒最佳
                            </div>
                            <div class="modal-layer-popup-number"><span>4</span><span>6</span><span>9</span></div>
                            <div class="modal-wrapper modal-point"><span class="modal-confirm-btn">
                                    记住了，开始录制
                                </span>
                                <!-- 点击录制视频 -->
                                <input type="file" accept="video/*" capture="user" class="camera-input video"
                                    id="video">
                            </div>
                        </div>
                        <span class="modal-layer-close"></span>
                    </div>
                </div>

                <div class="loading" style="display:none;">
                    <div class="loading-icon">验证中...</div>
                </div>
            </div>
        </div>
        
        <a href="./WorkMsg.html">
            <div class="next-buttons" >
                下 一 步
            </div>
        </a>
        <div class="ms-msg">
            版权公告 © 2018-2019 广州民盛互联网小额贷款有限公司<br>
            粤ICP备18017476号-1
        </div>
    </div>
</body>

<script>
    // vue
    var app = new Vue({
            el: "#app",
            data: {
                active: 1,
                form:{}
            },
            methods: {
                
            }
        });

    // 纯JS
    //读秒60
    function settime(seconds) {
        if (seconds > 1) {
            seconds--;
            $(".modal-layer-popup-content").html("此验证码将于<span>" + seconds +
                "</span>秒后过期<br>用普通话朗读数字，视频时长<span>3-6</span>秒最佳");
            tmid = setTimeout(function () {
                settime(seconds)
            }, 1000)
        } else {
            $(".modal-layer-popup-number").html("<span>" + Math.floor(Math.random() * 10) + "</span><span>" + Math
                .floor(Math.random() * 10) + "</span><span>" + Math.floor(Math.random() * 10) + "</span><span>" +
                Math.floor(Math.random() * 10) + "</span>");
            settime(60);
        }
    }
    //活体下一步
    $(".nextVideo").click(function () {
        //弹出随机数框
        $(".modal-layer").show();

        $.ajax({
                type: "POST",
                url: "https://dev.zxtouch.msxiaodai.com/rong360/getRandomNum",     //后台接口
                data: this.form,
                processData: false,
                contentType: false,
                xhr: function () {
                    myXhr = $.ajaxSettings.xhr();
                    return myXhr
                },
                //成功发送
                success: function (data) {
                    if(data.code==200){
                        console.log(data.msg)
                        console.log(data.data.random_number)
                        console.log(data.data.biz_no)
                        console.log(data.data.token_random_number)
                    }else{
                        console.log(data.msg)
                    }
                },
                //失败发送
                error: function (jqXHR, textStatus, errorThrown) {
                    $(".LivAlert").html(
                        "<div class='alert alert-danger alert-dismissable'><button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>服务器异常:" +
                        jqXHR.status + ":" + jqXHR.statusText + "</div>");
                    alert("错误返回：" + jqXHR.status + ":" + jqXHR.statusText);
                    $(".loading").hide();
                    $(".modal-layer").hide();
                    window.clearTimeout(tmid);
                    //window.location.reload();
                    //HJSJ.prompts("error",jqXHR.status+":"+jqXHR.statusText);
                }
            })
            
        //四位随机数计算
        $(".modal-layer-popup-number").html("<span>" + Math.floor(Math.random() * 10) + "</span><span>" + Math
            .floor(Math.random() * 10) + "</span><span>" + Math.floor(Math.random() * 10) +
            "</span><span>" + Math.floor(Math.random() * 10) + "</span>");

        //倒计时
        settime(60);
    })

    //关闭弹框
    $(".modal-layer-close").click(function () {
        $(".modal-layer").hide();
        window.clearTimeout(tmid);
    });

    //活体视频上传
    $("#video").change(function () {
        var file = $("#video").get(0).files[0];
        var fileSize = (this.files[0].size) / (1024 * 1024); //转换成M
        fileSize = fileSize.toFixed(0); //保留小数点后一位

        //判断文件大小是否大于18M
        if (fileSize > 18) {
            $(".LivAlert").html(
                "<div class='alert alert-danger alert-dismissable'><button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>视频时间，建议在3-6秒</div>"
            );
            //隐藏
            $(".modal-layer").hide();
            window.clearTimeout(tmid);
            return;
        } else {
            // alert("发送");
            //加载的动图显示
            $(".loading").show();
            var parameter = {};
            parameter["name"] = name;
            parameter["cardId"] = cardId;

            var formData = new FormData();
            formData.append("data", parameter);
            formData.append("video", file);

            //ajax提交视频
            $.ajax({
                type: "POST",
                url: "###",     //后台接口
                data: formData,
                processData: false,
                contentType: false,
                xhr: function () {
                    myXhr = $.ajaxSettings.xhr();
                    return myXhr
                },
                //成功发送
                success: function (data) {
                    //fileRequestData = data
                    alert("成功发送：" + data);
                    Submit(data);
                },
                //失败发送
                error: function (jqXHR, textStatus, errorThrown) {
                    $(".LivAlert").html(
                        "<div class='alert alert-danger alert-dismissable'><button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>服务器异常:" +
                        jqXHR.status + ":" + jqXHR.statusText + "</div>");
                    alert("错误返回：" + jqXHR.status + ":" + jqXHR.statusText);
                    $(".loading").hide();
                    $(".modal-layer").hide();
                    window.clearTimeout(tmid);
                    //window.location.reload();
                    //HJSJ.prompts("error",jqXHR.status+":"+jqXHR.statusText);
                }
            })
        }
    })
</script>

</html>